<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAOLSAT - Intelligence Agro-Spatiale</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { 
            --bg: #0b0f13; 
            --card: #161b22; 
            --accent: #2ecc71; 
            --danger: #f85149; 
            --warning: #f39c12;
            --text: #c9d1d9; 
            --border: #30363d;
        }
        
        body { 
            background: linear-gradient(135deg, #0b0f13 0%, #1a2f23 100%);
            color: var(--text); 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; padding: 0; 
        }

        /* Ruban Bourse */
        .ticker-wrap {
            background: rgba(28, 33, 40, 0.8);
            border-bottom: 1px solid var(--border);
            padding: 10px 0; overflow: hidden; white-space: nowrap;
            backdrop-filter: blur(10px);
        }
        .ticker {
            display: inline-block;
            animation: ticker-scroll 30s linear infinite;
            padding-left: 100%;
        }
        @keyframes ticker-scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .ticker-item { display: inline-block; margin-right: 50px; font-size: 0.9em; }

        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }

        header { 
            border-bottom: 1px solid var(--border); 
            margin-bottom: 20px; padding-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }

        .grid-main { 
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; 
        }

        @media (max-width: 1000px) { .grid-main { grid-template-columns: 1fr; } }

        .card { 
            background: rgba(22, 27, 34, 0.7); 
            border: 1px solid var(--border); border-radius: 15px; 
            padding: 15px; margin-bottom: 20px; backdrop-filter: blur(5px);
        }

        .field-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; 
        }

        #map { height: 400px; border-radius: 15px; border: 1px solid var(--border); margin-top: 20px; z-index: 1;}

        .tag { padding: 3px 8px; border-radius: 10px; font-size: 0.75em; font-weight: bold; }
        
        #chat { height: 450px; overflow-y: auto; margin-bottom: 15px; }
        .critical-msg { border-left: 4px solid var(--danger) !important; background: rgba(248, 81, 73, 0.1) !important; }
        
        input, textarea { 
            width: 100%; background: #0d1117; border: 1px solid var(--border); 
            color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box;
        }

        button { 
            padding: 12px; border-radius: 8px; border: none; font-weight: bold; 
            cursor: pointer; transition: 0.2s;
        }
        button:hover { transform: translateY(-2px); opacity: 0.9; }

        .weather-box {
            margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.5);
            border-radius: 5px; font-size: 0.85em; border-left: 2px solid var(--accent); color: white;
        }
    </style>
</head>
<body>

    <div class="ticker-wrap">
        <div class="ticker">
            {% for p in data.prices %}
            <div class="ticker-item">
                <span style="color: #8b949e;">{{ p.produit }}:</span> 
                <b style="color: var(--accent);">{{ p.prix }} FCFA</b> 
                <small>({{ p.unite }})</small>
                {% if p.tendance == 'up' %} <span style="color:var(--accent)">‚ñ≤</span> {% elif p.tendance == 'down' %} <span style="color:var(--danger)">‚ñº</span> {% else %} ‚ûñ {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="container">
        <header>
            <div>
                <h1 style="color: var(--accent); margin: 0;">üõ∞Ô∏è BAOLSAT CORE v2.6</h1>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #8b949e;">S√©n√©gal Central | {{ data.now }}</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <form action="/simulate_copernicus" method="POST">
                    <button type="submit" style="background: var(--warning); color: white;">üõ∞Ô∏è ANALYSE SATELLITE</button>
                </form>
            </div>
        </header>

        <div class="grid-main">
            <div class="content">
                <div class="card">
                    <h3 style="margin-top: 0; font-size: 1em;">üìä VIGUEUR V√âG√âTALE & RENDEMENTS</h3>
                    <div style="height: 200px;"><canvas id="yieldChart"></canvas></div>
                </div>

                <div class="field-grid">
                    {% for z in data.agri_data %}
                    <div class="card" style="border-top: 4px solid {{ 'var(--danger)' if z.ndvi < 0.6 else 'var(--accent)' }}">
                        <h4 style="margin: 0;">{{ z.zone }}</h4>
                        <div style="font-size: 0.8em; color: #8b949e; margin-bottom: 8px;">{{ z.culture }}</div>
                        <div style="font-size: 0.85em; line-height: 1.6;">
                            üå± NDVI: <b>{{ z.ndvi }}</b><br>
                            üå°Ô∏è Temp. Sol: <b>{{ z.temp }}¬∞C</b><br>
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: rgba(46, 204, 113, 0.1); border-radius: 5px; font-size: 0.9em;">
                            Rendement: <b>{{ z.rendement }} kg</b>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div id="map"></div>
            </div>

            <div class="sidebar">
                <div class="card">
                    <h3 style="margin-top: 0; color: var(--accent); font-size: 1em;">üì° FLUX DE TERRAIN</h3>
                    <div id="chat">
                        {% for m in data.messages %}
                        <div class="card {{ 'critical-msg' if m.is_critical }}" style="font-size: 0.85em; margin-bottom: 10px; padding: 10px; background: #0d1117;">
                            <b style="color: {{ 'var(--danger)' if m.is_critical else 'var(--accent)' }}">{{ m.user }}</b> 
                            <small style="float: right; color: #666;">{{ m.time }}</small><br>
                            <div style="margin-top: 5px;">{{ m.text }}</div>
                        </div>
                        {% endfor %}
                    </div>

                    <form action="/send_message" method="POST" enctype="multipart/form-data">
                        <input type="text" name="user" placeholder="Votre Nom / ID" required>
                        <textarea name="text" placeholder="Observations..." rows="3" required></textarea>
                        <button type="submit" style="width:100%; background: var(--accent); color: #000;">ENVOYER AU HUB</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. GRAPHIQUE
        const ctx = document.getElementById('yieldChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ data.agri_data|map(attribute='zone')|list|tojson }},
                datasets: [{
                    label: 'Rendement estim√©',
                    data: {{ data.agri_data|map(attribute='rendement')|list|tojson }},
                    backgroundColor: 'rgba(46, 204, 113, 0.6)',
                    borderColor: '#2ecc71',
                    borderWidth: 1
                }]
            },
            options: { 
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { grid: { color: '#30363d' } }, x: { grid: { display: false } } }
            }
        });

        // 2. CARTE & M√âT√âO
        var map = L.map('map').setView([14.49, -16.45], 8);
        L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function fetchWeather(lat, lon, elementId) {
            const container = document.getElementById(elementId);
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto`);
                const weather = await response.json();
                let html = "<div class='weather-box'><b>üå°Ô∏è Copernicus Meteo (3j) :</b><br>";
                for(let i=0; i<3; i++) {
                    html += `<div style="display:flex; justify-content:space-between;">
                                <span>Jour ${i+1}</span>
                                <span>${Math.round(weather.daily.temperature_2m_max[i])}¬∞C</span>
                             </div>`;
                }
                container.innerHTML = html + "</div>";
            } catch (e) { container.innerHTML = "M√©t√©o indisponible"; }
        }

        {% for z in data.agri_data %}
        (function() {
            var lat = {{ z.coords[0] }};
            var lon = {{ z.coords[1] }};
            var wId = "weather_{{ loop.index }}";
            var circle = L.circle([lat, lon], {
                color: '{{ "var(--danger)" if z.ndvi < 0.6 else "var(--accent)" }}',
                fillOpacity: 0.3, radius: 10000
            }).addTo(map);

            circle.bindPopup(`<div style="color:#000; min-width:150px;"><b>{{ z.zone }}</b><br>NDVI: {{ z.ndvi }}<br><div id="${wId}">‚è≥ Chargement m√©t√©o...</div></div>`);
            circle.on('popupopen', function() { fetchWeather(lat, lon, wId); });
        })();
        {% endfor %}
    </script>
</body>
</html>